<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>书籍章节阅读器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind自定义样式 -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            light: '#F8FAFC',
            dark: '#1E293B',
            'dark-bg': '#0F172A',
            'dark-card': '#1E293B',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          backdropFilter: {
            'blur': '8px',
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .glass-effect {
        @apply bg-white/80 backdrop-blur border border-white/30;
      }
      .glass-effect-dark {
        @apply bg-dark-card/80 backdrop-blur border border-gray-700/30;
      }
      .text-balance {
        text-wrap: balance;
      }
      .page-transition {
        @apply transition-all duration-300 ease-out;
      }
      .paragraph-appear {
        @apply opacity-0 transform translate-y-4 page-transition;
      }
      .paragraph-appear.active {
        @apply opacity-100 transform translate-y-0;
      }
      .smooth-focus {
        @apply transition-all duration-300 ease-out;
      }
    }
    
    /* 深色模式样式 */
    .dark .glass-effect {
      @apply glass-effect-dark;
    }
    .dark body {
      @apply bg-gradient-to-br from-dark-bg to-gray-900 text-gray-200;
    }
    .dark .hover\:bg-white\/50:hover {
      @apply hover:bg-gray-700/50;
    }
    .dark .hover\:bg-gray-100:hover {
      @apply hover:bg-gray-700;
    }
    .dark .text-gray-500 {
      @apply text-gray-400;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-light to-white min-h-screen font-sans text-dark antialiased">
  <!-- 顶部导航栏 -->
  <header class="fixed top-0 left-0 z-50 glass-effect p-3 w-full md:w-auto rounded-br-xl shadow-sm">
    <div class="flex items-center space-x-2">
      <button id="toc-btn" class="flex items-center justify-center p-2 rounded-full hover:bg-white/50 transition-colors">
        <i class="fa fa-bars text-xl"></i>
        <span class="ml-2 hidden md:inline">目录</span>
      </button>
      
      <!-- 深色模式切换按钮 -->
      <button id="dark-mode-toggle" class="flex items-center justify-center p-2 rounded-full hover:bg-white/50 transition-colors">
        <i class="fa fa-moon text-xl"></i>
        <span class="ml-2 hidden md:inline">深色模式</span>
      </button>
      
      <!-- 阅读模式切换按钮 -->
      <button id="reading-mode-toggle" class="flex items-center justify-center p-2 rounded-full hover:bg-white/50 transition-colors">
        <i class="fa fa-book text-xl"></i>
        <span id="reading-mode-text" class="ml-2 hidden md:inline">逐段阅读</span>
      </button>
    </div>
  </header>

  <!-- 目录侧边栏 (默认隐藏) -->
  <aside id="toc-sidebar" class="fixed top-0 left-0 h-full w-64 glass-effect transform -translate-x-full page-transition z-40 shadow-lg">
    <div class="p-6 h-full flex flex-col">
      <h2 class="text-2xl font-bold mb-6 border-b pb-2">章节目录</h2>
      <ul id="toc-list" class="space-y-3 flex-grow overflow-y-auto"></ul>
      <button id="close-toc" class="mt-4 p-3 rounded-lg hover:bg-gray-100 transition-colors">
        <i class="fa fa-times mr-2"></i>关闭
      </button>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="container mx-auto pt-20 pb-16 px-4 flex flex-col items-center justify-center min-h-screen">
    <!-- 章节标题 -->
    <h1 id="chapter-title" class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-center mb-12 paragraph-appear">加载中...</h1>
    
    <!-- 章节内容区域 -->
    <div id="content-container" class="w-full max-w-3xl glass-effect rounded-2xl p-6 md:p-8 shadow-lg">
      <div id="chapter-content" class="space-y-6 text-lg leading-relaxed"></div>
      
      <!-- 操作提示 -->
      <div id="action-hint" class="mt-8 text-center text-gray-500 paragraph-appear">
        点击或滑动开始阅读
      </div>
      
      <!-- 结束提示 (默认隐藏) -->
      <div id="end-message" class="mt-8 text-4xl font-bold text-center text-gray-400 paragraph-appear hidden">
        完
      </div>
    </div>
  </main>

  <script>
    // 应用状态
    const appState = {
      chapters: [],         // 章节数据
      currentChapterIndex: 0, // 当前章节索引
      currentParagraphIndex: 0, // 当前段落索引
      isLoading: true,      // 加载状态
      isPlaying: false,     // 播放状态
      touchStartY: 0,       // 触摸开始位置
      touchThreshold: 30,   // 滑动阈值
      isDarkMode: false,    // 深色模式状态
      isSegmentMode: true,  // 逐段阅读模式（true:逐段, false:完整）
    };

    // DOM元素
    const elements = {
      chapterTitle: document.getElementById('chapter-title'),
      chapterContent: document.getElementById('chapter-content'),
      actionHint: document.getElementById('action-hint'),
      endMessage: document.getElementById('end-message'),
      tocBtn: document.getElementById('toc-btn'),
      tocSidebar: document.getElementById('toc-sidebar'),
      tocList: document.getElementById('toc-list'),
      closeToc: document.getElementById('close-toc'),
      darkModeToggle: document.getElementById('dark-mode-toggle'),
      readingModeToggle: document.getElementById('reading-mode-toggle'),
      readingModeText: document.getElementById('reading-mode-text'),
      contentContainer: document.getElementById('content-container')
    };

    // 初始化应用
    async function initApp() {
      try {
        // 加载章节配置
        const chapters = await loadChapters();
        appState.chapters = chapters;
        
        if (chapters.length === 0) {
          throw new Error('未找到章节数据');
        }
        
        // 加载第一个章节内容
        await loadChapterContent(0);
        
        // 渲染目录
        renderTableOfContents();
        
        appState.isLoading = false;
        updateUI();
        
        // 检查用户是否保存了偏好设置
        checkUserPreferences();
      } catch (error) {
        console.error('应用初始化失败:', error);
        elements.chapterTitle.textContent = '加载失败';
        elements.actionHint.textContent = '请检查网络连接';
        appState.isLoading = false;
      }
    }

    // 检查用户偏好设置
    function checkUserPreferences() {
      // 检查深色模式偏好
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedDarkMode = localStorage.getItem('darkMode');
      
      if (savedDarkMode !== null) {
        appState.isDarkMode = savedDarkMode === 'true';
      } else {
        appState.isDarkMode = prefersDark;
      }
      
      // 应用深色模式
      updateDarkMode();
      
      // 检查阅读模式偏好
      const savedReadingMode = localStorage.getItem('readingMode');
      if (savedReadingMode !== null) {
        appState.isSegmentMode = savedReadingMode === 'true';
        updateReadingModeText();
      }
    }

    // 加载章节配置
    async function loadChapters() {
      try {
        // 注意：这里需要根据实际服务器路径调整URL
        const response = await fetch('book/chapter.json');
        if (!response.ok) {
          throw new Error(`HTTP错误! 状态码: ${response.status}`);
        }
        
        const data = await response.json();
        return Object.entries(data).map(([path, title], index) => ({
          index,
          path,
          title: `第${index + 1}章 - ${title}`
        }));
      } catch (error) {
        console.error('加载章节配置失败:', error);
        return [];
      }
    }

    // 加载章节内容
    async function loadChapterContent(chapterIndex) {
      try {
        const chapter = appState.chapters[chapterIndex];
        if (!chapter) return;
        
        // 更新状态
        appState.currentChapterIndex = chapterIndex;
        appState.currentParagraphIndex = 0;
        appState.isPlaying = false;
        
        // 更新标题
        elements.chapterTitle.textContent = chapter.title;
        elements.chapterTitle.classList.remove('active');
        void elements.chapterTitle.offsetWidth; // 触发重绘
        elements.chapterTitle.classList.add('active');
        
        // 清空内容区
        elements.chapterContent.innerHTML = '';
        elements.endMessage.classList.add('hidden');
        elements.actionHint.style.display = 'block';
        
        // 加载章节内容文件
        // 注意：这里需要根据实际服务器路径调整URL
        const response = await fetch(chapter.path);
        if (!response.ok) {
          throw new Error(`HTTP错误! 状态码: ${response.status}`);
        }
        
        const content = await response.text();
        
        // 修改点：按行分割文本，每行作为一段
        const paragraphs = content.split('\n')
          .map(p => p.trim())
          .filter(p => p); // 过滤空行
        
        // 渲染段落
        paragraphs.forEach((paragraph, index) => {
          const paragraphElement = document.createElement('p');
          paragraphElement.className = 'paragraph-appear smooth-focus';
          paragraphElement.textContent = paragraph;
          
          if (appState.isSegmentMode && index > 0) {
            paragraphElement.style.display = 'none';
          } else {
            paragraphElement.classList.add('active');
          }
          
          elements.chapterContent.appendChild(paragraphElement);
        });
        
        // 更新操作提示
        if (appState.isSegmentMode) {
          elements.actionHint.textContent = '点击或滑动查看下一段';
        } else {
          elements.actionHint.textContent = '本章内容已完整显示';
        }
        
      } catch (error) {
        console.error(`加载章节内容失败 (章节: ${chapterIndex}):`, error);
        elements.chapterContent.innerHTML = '<p class="text-red-500">内容加载失败</p>';
      }
    }

    // 显示下一段内容
    function showNextParagraph() {
      if (!appState.isSegmentMode) {
        // 完整模式不需要分段显示
        return;
      }
      
      const paragraphs = elements.chapterContent.querySelectorAll('p');
      if (appState.currentParagraphIndex >= paragraphs.length - 1) {
        // 本章已全部显示，加载下一章
        loadNextChapter();
        return;
      }
      
      appState.currentParagraphIndex++;
      const nextParagraph = paragraphs[appState.currentParagraphIndex];
      
      // 隐藏操作提示
      if (appState.currentParagraphIndex > 0) {
        elements.actionHint.style.display = 'none';
      }
      
      // 显示下一段
      nextParagraph.style.display = 'block';
      nextParagraph.classList.remove('paragraph-appear');
      void nextParagraph.offsetWidth; // 触发重绘
      nextParagraph.classList.add('paragraph-appear', 'active');
      
      // 滚动到新段落（平滑聚焦）
      nextParagraph.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // 添加聚焦动画效果
      nextParagraph.classList.add('bg-blue-50', 'dark:bg-blue-900/30');
      setTimeout(() => {
        nextParagraph.classList.remove('bg-blue-50', 'dark:bg-blue-900/30');
      }, 1000);
    }

    // 加载下一章
    async function loadNextChapter() {
      if (appState.currentChapterIndex >= appState.chapters.length - 1) {
        // 所有章节已播放完毕
        showEndMessage();
        return;
      }
      
      appState.currentChapterIndex++;
      appState.currentParagraphIndex = 0;
      await loadChapterContent(appState.currentChapterIndex);
    }

    // 显示结束消息
    function showEndMessage() {
      elements.chapterContent.innerHTML = '';
      elements.actionHint.style.display = 'none';
      elements.endMessage.classList.remove('hidden');
      elements.endMessage.classList.remove('paragraph-appear');
      void elements.endMessage.offsetWidth; // 触发重绘
      elements.endMessage.classList.add('paragraph-appear', 'active');
    }

    // 渲染目录
    function renderTableOfContents() {
      elements.tocList.innerHTML = '';
      
      appState.chapters.forEach(chapter => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = chapter.title;
        a.classList.add('block', 'p-2', 'rounded', 'hover:bg-gray-100', 'transition-colors', 'dark:hover:bg-gray-700');
        
        // 高亮当前章节
        if (chapter.index === appState.currentChapterIndex) {
          a.classList.add('bg-blue-100', 'dark:bg-blue-900/50');
        }
        
        a.addEventListener('click', (e) => {
          e.preventDefault();
          loadChapterContent(chapter.index);
          closeTocSidebar();
        });
        
        li.appendChild(a);
        elements.tocList.appendChild(li);
      });
    }

    // 打开目录侧边栏
    function openTocSidebar() {
      elements.tocSidebar.classList.remove('-translate-x-full');
      document.body.style.overflow = 'hidden'; // 防止背景滚动
    }

    // 关闭目录侧边栏
    function closeTocSidebar() {
      elements.tocSidebar.classList.add('-translate-x-full');
      document.body.style.overflow = ''; // 恢复背景滚动
    }

    // 切换深色模式
    function toggleDarkMode() {
      appState.isDarkMode = !appState.isDarkMode;
      updateDarkMode();
      
      // 保存用户偏好
      localStorage.setItem('darkMode', appState.isDarkMode);
    }

    // 更新深色模式UI
    function updateDarkMode() {
      if (appState.isDarkMode) {
        document.documentElement.classList.add('dark');
        elements.darkModeToggle.innerHTML = '<i class="fa fa-sun text-xl"></i><span class="ml-2 hidden md:inline">浅色模式</span>';
      } else {
        document.documentElement.classList.remove('dark');
        elements.darkModeToggle.innerHTML = '<i class="fa fa-moon text-xl"></i><span class="ml-2 hidden md:inline">深色模式</span>';
      }
    }

    // 切换阅读模式
    function toggleReadingMode() {
      appState.isSegmentMode = !appState.isSegmentMode;
      updateReadingModeText();
      
      // 重新加载当前章节以应用新模式
      loadChapterContent(appState.currentChapterIndex);
      
      // 保存用户偏好
      localStorage.setItem('readingMode', appState.isSegmentMode);
    }

    // 更新阅读模式文本
    function updateReadingModeText() {
      if (appState.isSegmentMode) {
        elements.readingModeText.textContent = '逐段阅读';
      } else {
        elements.readingModeText.textContent = '完整阅读';
      }
    }

    // 更新UI状态
    function updateUI() {
      if (appState.isLoading) {
        elements.chapterTitle.textContent = '加载中...';
        elements.chapterContent.innerHTML = '';
        elements.actionHint.textContent = '';
        return;
      }
    }

    // 事件监听
    function setupEventListeners() {
      // 点击事件 - 查看下一段或开始播放
      document.addEventListener('click', (e) => {
        // 忽略目录相关点击
        if (e.target.closest('#toc-btn') || e.target.closest('#toc-sidebar') || 
            e.target.closest('#dark-mode-toggle') || e.target.closest('#reading-mode-toggle')) {
          return;
        }
        
        if (appState.isLoading) return;
        
        if (!appState.isPlaying) {
          appState.isPlaying = true;
          if (appState.isSegmentMode) {
            elements.actionHint.textContent = '点击或滑动查看下一段';
          }
        } else if (appState.isSegmentMode) {
          showNextParagraph();
        }
      });

      // 触摸事件 - 滑动查看下一段
      document.addEventListener('touchstart', (e) => {
        appState.touchStartY = e.touches[0].clientY;
      });

      document.addEventListener('touchend', (e) => {
        if (appState.isLoading || !appState.isSegmentMode) return;
        
        const touchEndY = e.changedTouches[0].clientY;
        const touchDiff = appState.touchStartY - touchEndY; // 向上滑动为正
        
        if (touchDiff > appState.touchThreshold) {
          // 向上滑动，查看下一段
          if (!appState.isPlaying) {
            appState.isPlaying = true;
            elements.actionHint.textContent = '点击或滑动查看下一段';
          } else {
            showNextParagraph();
          }
        }
      });

      // 目录按钮点击 - 切换侧边栏
      elements.tocBtn.addEventListener('click', () => {
        if (elements.tocSidebar.classList.contains('-translate-x-full')) {
          openTocSidebar();
        } else {
          closeTocSidebar();
        }
      });
      
      // 关闭目录按钮点击
      elements.closeToc.addEventListener('click', closeTocSidebar);
      
      // 点击目录以外区域关闭目录
      elements.tocSidebar.addEventListener('click', (e) => {
        if (e.target === elements.tocSidebar) {
          closeTocSidebar();
        }
      });
      
      // 深色模式切换
      elements.darkModeToggle.addEventListener('click', toggleDarkMode);
      
      // 阅读模式切换
      elements.readingModeToggle.addEventListener('click', toggleReadingMode);
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', () => {
      initApp().then(() => {
        setupEventListeners();
      });
    });
  </script>
</body>
</html>